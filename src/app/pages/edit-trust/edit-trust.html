<!-- Loading spinner overlay with blur -->
<div *ngIf="loading" class="loading-overlay" aria-live="assertive" aria-busy="true">
  <div class="spinner-border text-primary" role="status" aria-label="Loading...">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<div class="min-h-screen flex justify-center items-start md:items-center px-3 md:px-6 py-6 md:py-12 bg-gradient-to-br from-[#033f63]/10 to-[#28666e]/10">
<form [formGroup]="trustForm" enctype="multipart/form-data" class="edit-trust-container w-full">
  <div class="container mx-auto px-4 md:px-6 py-4 space-y-6" style="max-width: 900px;">
    <!-- Header -->
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-3">
      <div class="d-flex align-items-center gap-3">
        <button type="button" class="btn btn-outline-primary rounded-circle inline-flex items-center justify-center w-10 h-10" (click)="goBackToHome()" aria-label="Back">
          <i class="bi bi-arrow-left"></i>
        </button>
        <div>
          <h2 class="mb-1 fw-bold text-primary tracking-tight">Edit Hong Kong Foreign Trust</h2>
          <div class="text-muted small">Find your trust, update the details, and pay the R165 amendment fee.</div>
        </div>
      </div>
      <div>
        <button type="button" class="btn btn-primary btn-lg rounded-pill d-flex align-items-center gap-2 px-4 py-2 shadow" (click)="openEditModal()">
          <i class="bi bi-search"></i>
          Lookup Trust
        </button>
      </div>
    </div>
    <!-- Step indicator -->
    <div class="d-flex flex-wrap gap-2 align-items-center mb-4">
      <span class="badge rounded-pill text-bg-primary"><span class="me-1">1</span> Lookup</span>
      <i class="bi bi-arrow-right"></i>
      <span class="badge rounded-pill text-bg-secondary"><span class="me-1">2</span> Review & Edit</span>
      <i class="bi bi-arrow-right"></i>
      <span class="badge rounded-pill text-bg-primary"><span class="me-1">3</span> Pay & Save</span>
    </div>

    <!-- R165 Payment Notice -->
    <div class="alert alert-primary border-2 shadow-sm mb-4 ring-1 ring-[#033f63]/20 rounded-xl" role="note" aria-label="Edit trust form fee notice">
      <div class="d-flex align-items-start gap-3">
        <i class="bi bi-exclamation-triangle-fill fs-3"></i>
        <div>
          <div class="text-uppercase fw-bold small mb-1">Important</div>
          <ul class="mb-0 ps-3">
            <li class="mb-1">The deed and supporting documents are signed electronically by each required party.</li>
            <li class="mb-1">Each party must provide a valid email. Two parties may share an email (e.g. spouses).</li>
            <li class="fw-semibold">Editing an existing trust costs <span class="text-dark">R165</span>.</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Edit mode banner -->
    <div *ngIf="isEditMode" class="alert alert-secondary d-flex align-items-center gap-3 rounded-4 shadow-sm mb-4">
      <i class="bi bi-info-circle fs-4"></i>
      <div class="flex-grow-1">
        <div class="fw-semibold">Editing existing trust</div>
        <div class="small text-muted">
          <span class="me-2">Trust No: <span class="badge bg-secondary text-white border">{{ editTrustNumber }}</span></span>
          <span>Trust Name: <span class="badge bg-secondary text-white border">{{ editTrustName }}</span></span>
        </div>
      </div>
      <button type="button" class="btn btn-outline-secondary btn-sm" (click)="exitEditMode()">Exit</button>
    </div>

    <!-- General Info Section -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-light d-flex align-items-center gap-2 fs-5 border-bottom">
        <i class="bi bi-person-badge text-primary"></i>
        <span class="fw-semibold">General Info</span>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Full Names and Surname *</label>
            <input formControlName="fullName" type="text" required minlength="2" class="form-control form-control-lg border-secondary-subtle rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]"
              placeholder="Full name" />
            <div class="text-danger mt-1 fst-italic"
              *ngIf="trustForm.get('fullName')?.invalid && trustForm.get('fullName')?.touched">
              Please enter your full name.
            </div>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Passport or ID Number *</label>
            <input formControlName="idNumber" type="text" required pattern="[0-9]{6,}" class="form-control form-control-lg border-secondary-subtle rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]"
              placeholder="Document number" />
            <div class="text-danger mt-1 fst-italic"
              *ngIf="trustForm.get('idNumber')?.invalid && trustForm.get('idNumber')?.touched">
              Please enter your ID or passport number.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Details Section -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-light d-flex align-items-center gap-2 fs-5 border-bottom">
        <i class="bi bi-envelope-at text-secondary"></i>
        <span class="fw-semibold">Contact Details</span>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Email *</label>
            <input formControlName="email" type="email" required email class="form-control form-control-lg border-secondary-subtle rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]"
              placeholder="you@example.com" />
            <div class="text-danger mt-1 fst-italic"
              *ngIf="trustForm.get('email')?.invalid && trustForm.get('email')?.touched">
              Please enter a valid email.
            </div>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold">Phone Number *</label>
            <input formControlName="phoneNumber" type="text" required pattern="^(\+?\d{10,15})$" class="form-control form-control-lg border-secondary-subtle"
              placeholder="+27..." />
            <div class="text-danger mt-1 fst-italic"
              *ngIf="trustForm.get('phoneNumber')?.invalid && trustForm.get('phoneNumber')?.touched">
              Please enter your phone number.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Trust Details Section -->
    <div class="card border-primary shadow-sm mb-4">
      <div class="card-header bg-primary text-white fs-5 d-flex align-items-center gap-2">
        <i class="bi bi-diagram-3"></i>
        <span class="fw-semibold">Trust Details</span>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <!-- Trust Email -->
          <div class="col-12 col-md-4">
            <label class="form-label">Trust Email (Optional)</label>
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
            <input formControlName="trustEmail" type="email" class="form-control w-100 w-md-auto rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]"
              placeholder="trust@example.com" [readonly]="useUserEmailForTrustEmail" />
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="useUserEmailCheckbox"
                       [checked]="useUserEmailForTrustEmail" (change)="toggleUseUserEmailForTrustEmail($event)" />
                <label class="form-check-label" for="useUserEmailCheckbox">Use my email</label>
              </div>
            </div>
            <div class="text-danger mt-1 fst-italic"
                 *ngIf="trustForm.get('trustEmail')?.invalid && trustForm.get('trustEmail')?.touched">
              Please enter a valid trust email.
            </div>
            <div class="form-text">When checked, the trust email mirrors your email automatically.</div>
          </div>
          <!-- Name of Trust -->
          <div class="col-12 col-md-4">
            <label class="form-label">Name of Trust *</label>
            <input formControlName="trustName" type="text" required class="form-control w-100 rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" [readonly]="isEditMode" />
            <div class="text-danger mt-1 fst-italic"
                 *ngIf="trustForm.get('trustName')?.invalid && trustForm.get('trustName')?.touched">
              Please enter a trust name.
            </div>
            <div class="text-danger mt-1 fst-italic"
                 *ngIf="trustForm.get('trustName')?.errors?.['forbiddenWords'] && trustForm.get('trustName')?.touched">
              Do not include the words "The", "Trust", "Hong", "Kong" and "Foreign" in the trust name â€” they are automatically added.
            </div>
            <div *ngIf="trustForm.get('trustName')?.value && !isEditMode" class="mt-2">
              <div class="mb-1 text-primary fw-bold small">THIS IS YOUR TRUST FULL NAME</div>
              <span class="badge rounded-pill bg-primary text-light fw-bold px-3 py-2">
                The {{ trustForm.get('trustName')?.value }} Hong Kong Foreign Trust
              </span>
            </div>
          </div>
          <!-- Date of Establishment -->
          <div class="col-12 col-md-4">
            <label class="form-label">Date of Establishment *</label>
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-3">
              <input formControlName="establishmentDate" type="date" required class="form-control w-100 rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" />
              <div *ngIf="trustForm.get('establishmentDate')?.value" class="text-muted"><em>{{ trustForm.get('establishmentDate')?.value | date: 'd MMMM yyyy' }}</em></div>
            </div>
            <div class="text-danger mt-1 fst-italic"
                 *ngIf="trustForm.get('establishmentDate')?.invalid && trustForm.get('establishmentDate')?.touched">
              Please select a date of establishment.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settlor Section -->
    <div class="card border-0 shadow-sm mb-4" formGroupName="settlor">
      <div class="card-header bg-light d-flex align-items-center gap-2 fs-5 border-bottom">
        <i class="bi bi-person-lines-fill text-primary"></i>
        <span class="fw-semibold">Settlor</span>
        <div class="form-check form-switch ms-auto mb-0">
          <input type="checkbox" id="isSettlorCheckbox" class="form-check-input"
            [checked]="trustForm.get('isSettlor')?.value" (change)="onSettlorCheckboxChange($event)" [disabled]="isEditMode" />
          <label for="isSettlorCheckbox" class="form-check-label">I am the Settlor</label>
        </div>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label>Full Name *</label>
            <input type="text" formControlName="name" required [readonly]="trustForm.get('isSettlor')?.value"
              class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" />
            <div class="text-danger mt-1 fst-italic"
              *ngIf="trustForm.get('settlor.name')?.invalid && trustForm.get('settlor.name')?.touched">
              Settlor name is required.
            </div>
          </div>
          <div class="col-12 col-md-4">
            <label>ID / Passport No *</label>
            <input type="text" formControlName="id" required pattern="[0-9]{6,}" [readonly]="trustForm.get('isSettlor')?.value"
              class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" />
            <div class="text-danger mt-1 fst-italic"
              *ngIf="trustForm.get('settlor.id')?.invalid && trustForm.get('settlor.id')?.touched">
              Settlor ID/Passport is required.
            </div>
          </div>
          <div class="col-12 col-md-4">
            <label>Email *</label>
            <input type="email" formControlName="email" required email class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" placeholder="settlor@example.com" />
            <div class="text-danger mt-1 fst-italic" *ngIf="trustForm.get('settlor.email')?.invalid && trustForm.get('settlor.email')?.touched">
              Settlor email is required.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Trustees Section -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-light d-flex align-items-center gap-2 fs-5 border-bottom">
        <i class="bi bi-people text-warning"></i>
        <span class="fw-semibold">Trustees</span>
      </div>
      <div class="card-body pb-2">
        <div class="row g-4">
          <!-- Trustee 1 -->
          <div class="col-12 col-md-4">
            <div class="mb-3">
              <label class="form-label fw-semibold d-flex align-items-center gap-2">
                <span class="text-primary">Trustee 1</span>
                <div class="form-check form-switch mb-0 ms-auto">
                  <input type="checkbox" id="isTrusteeCheckbox" class="form-check-input"
                    [checked]="trustForm.get('isTrustee')?.value" (change)="onTrusteeCheckboxChange($event)" [disabled]="isEditMode" />
                  <label for="isTrusteeCheckbox" class="form-check-label">I am Trustee 1</label>
                </div>
              </label>
              <div [formGroup]="firstTrustee" class="card border-0 shadow-sm bg-light-subtle p-3">
                <label>Full Name *</label>
                <input type="text" formControlName="name" required [readonly]="trustForm.get('isTrustee')?.value" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" />
                <div class="text-danger mt-1 fst-italic" *ngIf="firstTrustee.get('name')?.invalid && firstTrustee.get('name')?.touched">
                  Trustee 1 name is required.
                </div>
                <label class="mt-2">ID / Passport No *</label>
                <input type="text" formControlName="id" required pattern="[0-9]{6,}" [readonly]="trustForm.get('isTrustee')?.value" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" />
                <div class="text-danger mt-1 fst-italic" *ngIf="firstTrustee.get('id')?.invalid && firstTrustee.get('id')?.touched">
                  Trustee 1 ID/Passport is required.
                </div>
                <label class="mt-2">Email *</label>
                <input type="email" formControlName="email" required email class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" placeholder="trustee1@example.com" />
                <div class="text-danger mt-1 fst-italic" *ngIf="firstTrustee.get('email')?.invalid && firstTrustee.get('email')?.touched">
                  Trustee 1 email is required.
                </div>
              </div>
            </div>
          </div>
          <!-- Trustee 2 -->
          <div class="col-12 col-md-4" [formGroup]="secondTrustee">
            <div class="mb-3">
              <label class="form-label fw-semibold text-primary">Trustee 2 *</label>
              <div class="card border-0 shadow-sm bg-light-subtle p-3">
                <label>Full Name *</label>
                <input type="text" formControlName="name" required class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" />
                <div class="text-danger mt-1 fst-italic" *ngIf="secondTrustee.get('name')?.invalid && secondTrustee.get('name')?.touched">
                  Trustee 2 name is required.
                </div>
                <label class="mt-2">ID / Passport No *</label>
                <input type="text" formControlName="id" required pattern="[0-9]{6,}" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" />
                <div class="text-danger mt-1 fst-italic" *ngIf="secondTrustee.get('id')?.invalid && secondTrustee.get('id')?.touched">
                  Trustee 2 ID is required.
                </div>
                <label class="mt-2">Email *</label>
                <input type="email" formControlName="email" required email class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" placeholder="trustee2@example.com" />
                <div class="text-danger mt-1 fst-italic" *ngIf="secondTrustee.get('email')?.invalid && secondTrustee.get('email')?.touched">
                  Trustee 2 email is required.
                </div>
              </div>
            </div>
          </div>
          <!-- Trustee 3 -->
          <div class="col-12 col-md-4">
            <div class="mb-3" [formGroup]="thirdTrustee">
              <label class="form-label fw-semibold text-primary">Trustee 3 (Optional)</label>
              <div class="card border-0 shadow-sm bg-light-subtle p-3">
                <label>Full Name</label>
                <input type="text" formControlName="name" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" placeholder="Full name" />
                <label class="mt-2">ID / Passport No</label>
                <input type="text" formControlName="id" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" placeholder="ID/Passport" />
                <label class="mt-2">Email</label>
                <input type="email" formControlName="email" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" placeholder="trustee3@example.com" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Beneficiaries Section -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-header bg-light d-flex align-items-center gap-2 fs-5 border-bottom">
        <i class="bi bi-list-ul text-success"></i>
        <span class="fw-semibold">Beneficiaries</span>
      </div>
      <div class="card-body">
        <label class="form-label fw-semibold d-flex align-items-center gap-3">
          List of Beneficiaries
          <span class="badge rounded-pill bg-warning text-dark">MAY NOT BE A TRUSTEE</span>
        </label>
        <textarea formControlName="beneficiaries" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" rows="4" (blur)="onBeneficiariesBlur()"
          placeholder="e.g. John Lee - 9001011234567"></textarea>
        <div class="form-text">Tip: We alert you if any trustee appears in this list.</div>
      </div>
    </div>

    <!-- Lease Agreement Section -->
    <div class="card border-info-subtle shadow-sm mb-4">
      <div class="card-header bg-info text-white fs-5 d-flex align-items-center gap-2">
        <i class="bi bi-house-door"></i>
        <span class="fw-semibold">Lease Agreement</span>
      </div>
      <div class="card-body">
        <div class="alert alert-warning border-2 shadow-sm mb-4" role="note" aria-label="Lease agreement guidance">
          <div class="text-uppercase fw-bold small mb-2">Lease Agreement Notes</div>
          <ul class="mb-0 ps-3">
            <li>You can use your residential address as administrative office for your trust.</li>
            <li>The document can be used as Proof of Address for your Trust.</li>
            <li>The Owner is the Lessor and the Trust is the Lessee.</li>
            <li>The Signer is different than the owner and generally one of the other trustees who signs on behalf of the Trust.</li>
          </ul>
        </div>
        <div class="row g-4 align-items-start">
          <!-- Left: Lease fields -->
          <div class="col-12 col-lg-7">
            <div class="mb-4">
              <label class="form-label fw-semibold">Property Address (One Line) *</label>
              <input formControlName="propertyAddress" type="text" required class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" placeholder="e.g. 187 Kameeldrift Weg, Roodepoort, Pretoria, Gauteng, South Africa, 0182" />
              <div class="text-danger mt-1 fst-italic" *ngIf="trustForm.get('propertyAddress')?.invalid && trustForm.get('propertyAddress')?.touched">
                Please enter the property address.
              </div>
            </div>
            <div class="mb-4">
              <label class="form-label fw-semibold">Property Owner (Whose name the property is in) *</label>
              <input formControlName="propertyOwner" type="text" required class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]"
               placeholder="Defaults to Trustee 1" />
              <div class="form-text">By default, this will use Trustee 1's details (name, ID, email).</div>
              <div class="mb-2">
                <label class="form-label">Owner ID</label>
                <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" [value]="firstTrustee.get('id')?.value" readonly />
              </div>
              <div class="mb-2">
                <label class="form-label">Owner Email</label>
                <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" [value]="firstTrustee.get('email')?.value" readonly />
              </div>
              <div class="text-danger mt-1 fst-italic"
                   *ngIf="trustForm.get('propertyOwner')?.invalid && trustForm.get('propertyOwner')?.touched">
                Please specify whose name the property is in.
              </div>
            </div>
          </div>
          <!-- Right: Signer Details (Usually Trustee 2) -->
          <div class="col-12 col-lg-5">
            <label class="form-label fw-semibold text-primary fs-5 d-flex align-items-center gap-2">
              Signer Details <span class="badge bg-secondary text-white border">Usually Trustee 2</span>
            </label>
            <div class="card border-0 shadow-sm bg-light-subtle p-3">
              <div class="row g-3">
                <div class="col-12">
                  <label class="form-label">Signer Name *</label>
                  <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" required formControlName="signer_name" placeholder="Usually Trustee 2 full name" />
                  <div class="text-danger mt-1 fst-italic" *ngIf="trustForm.get('signer_name')?.invalid && trustForm.get('signer_name')?.touched">
                    Signer name is required.
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Signer ID / Passport No *</label>
                  <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" required pattern="[0-9]{6,}" formControlName="signer_id" placeholder="Usually Trustee 2 ID / Passport" />
                  <div class="text-danger mt-1 fst-italic" *ngIf="trustForm.get('signer_id')?.invalid && trustForm.get('signer_id')?.touched">
                    Signer ID / Passport is required.
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Signer Email *</label>
                  <input type="email" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" required email formControlName="signer_email" placeholder="Usually trustee2@example.com" />
                  <div class="text-danger mt-1 fst-italic" *ngIf="trustForm.get('signer_email')?.invalid && trustForm.get('signer_email')?.touched">
                    Please enter a valid signer email.
                  </div>
                </div>
              </div>
              <div class="form-text mt-2">
                These fields auto-fill from Trustee 2 if left blank.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

   

    <!-- Save Changes Button in Sticky Footer -->
    <div class="sticky-bottom-footer bg-white py-3 px-2 shadow-lg border-top d-flex justify-content-center" style="z-index: 10;">
      <button type="button"
        class="btn btn-primary fw-bold btn-lg px-5 py-3 shadow"
        [disabled]="editSaving"
        data-bs-toggle="modal"
        data-bs-target="#paymentMethodModal"
        style="font-size: 1.2rem;">
        <span class="spinner-border spinner-border-sm me-2" *ngIf="editSaving" role="status" aria-hidden="true"></span>
        ðŸ’¾ Save Changes (Pay R165)
      </button>
    </div>

    <!-- Modal: Conflict Warning -->
    <div class="modal fade" id="trusteeConflictModal" #trusteeConflictModal tabindex="-1"
      aria-labelledby="trusteeConflictModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-primary">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="trusteeConflictModalLabel">ðŸš« Invalid Entry</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
              aria-label="Close"></button>
          </div>
          <div class="modal-body">
            You cannot add a trustee as a beneficiary. Please revise your list.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Method Selection Modal -->
    <div class="modal fade" id="paymentMethodModal" #paymentMethodModal tabindex="-1"
      aria-labelledby="paymentMethodModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-primary">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="paymentMethodModalLabel">Choose Payment Method</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
              aria-label="Close"></button>
          </div>
          <div class="modal-body" [formGroup]="trustForm">
            <div class="d-grid gap-3">
            <button type="button" class="btn btn-primary btn-lg d-flex align-items-center justify-content-center gap-2"
                      (click)="trustForm.get('paymentMethod')?.setValue('cardEFT'); confirmPaymentMethod()"
                      data-bs-dismiss="modal">
                <i class="bi bi-credit-card"></i>
                Pay with Card / EFT
              </button>
              <button type="button" class="btn btn-outline-dark btn-lg d-flex align-items-center justify-content-center gap-2"
                      (click)="trustForm.get('paymentMethod')?.setValue('crypto')"
                      data-bs-target="#customCryptoModal" data-bs-toggle="modal" data-bs-dismiss="modal">
                <i class="bi bi-currency-bitcoin"></i>
                Pay with Crypto (XRP)
              </button>
            </div>
            <div class="form-text mt-3 text-center">Choose a payment method to continue.</div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Crypto Payment Modal -->
    <div class="modal fade" id="customCryptoModal" tabindex="-1" aria-labelledby="customCryptoModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-dark">
          <div class="modal-header bg-secondary text-white">
            <h5 class="modal-title d-flex align-items-center gap-2" id="customCryptoModalLabel">
              <i class="bi bi-currency-bitcoin"></i>
              Crypto Payment (XRP)
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="vstack gap-3">
              <div class="alert alert-secondary mb-0" role="note">
                <div class="fw-semibold mb-1">How it works</div>
                <ol class="mb-0 ps-3">
                  <li>Pay the edit fee using <strong>XRP</strong> to the address below.</li>
                  <li>Paste the <strong>64-character XRP transaction ID</strong> (hash) and continue.</li>
                  <li>We will process your edit once submitted.</li>
                </ol>
              </div>

              <div class="d-flex justify-content-between align-items-center border rounded p-3">
                <div>
                  <div class="text-muted small">Amount</div>
                  <div class="fs-5 fw-bold">R165</div>
                  <div class="small text-muted mt-1">â‰ˆ {{ xrpAmountDisplay }}</div>
                </div>
                <div>
                  <span class="badge text-bg-primary" *ngIf="!xrpQuoteLoading">XRP Supported</span>
                  <span class="badge text-bg-secondary" *ngIf="xrpQuoteLoading">Fetching rateâ€¦</span>
                </div>
              </div>

              <div class="border rounded p-3">
                <div class="text-muted small mb-1">Pay to this XRP address</div>
                <div class="input-group">
                  <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" [value]="'rMuStHBy5N17ysmiQjUj4QQv5DTk8ovWDS'" readonly>
                  <button type="button" class="btn btn-outline-secondary" (click)="copyToClipboard('rMuStHBy5N17ysmiQjUj4QQv5DTk8ovWDS')">Copy</button>
                </div>
              </div>

              <div>
                <label class="form-label">XRP Transaction ID (64â€‘character hex) *</label>
                <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" required pattern="[a-fA-F0-9]{64}" [(ngModel)]="cryptoTxId" [ngModelOptions]="{standalone: true}" name="cryptoTxId" placeholder="e.g. A3F0... (64 hex chars)" maxlength="64" />
                <div class="text-danger mt-1 fst-italic" *ngIf="cryptoTxId && !isValidHex64(cryptoTxId)">
                  Please enter a valid 64-character hexadecimal transaction ID.
                </div>
              </div>

              <div class="form-text">We use CoinGecko to estimate the XRP amount in real-time.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Back</button>
            <button type="button" class="btn btn-primary d-inline-flex align-items-center gap-2" (click)="handleCryptoManualConfirm()" data-bs-dismiss="modal">
              <i class="bi bi-arrow-right-circle"></i>
              I've Paid â€” Continue
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Existing Trust: Lookup Modal -->
    <div class="modal fade" id="editTrustModal" #editTrustModal tabindex="-1" aria-labelledby="editTrustModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
          <div class="modal-header bg-secondary text-white">
            <h5 class="modal-title d-flex align-items-center gap-2" id="editTrustModalLabel">
              <i class="bi bi-pencil-square"></i>
              Edit Existing Trust
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form [formGroup]="editLookupForm" class="vstack gap-3">
              <div>
                <label class="form-label">Trust Number</label>
                <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" formControlName="trust_number" placeholder="e.g. 3205/25" />
                <div class="text-danger mt-1 fst-italic" *ngIf="editLookupForm.get('trust_number')?.invalid && editLookupForm.get('trust_number')?.touched">
                  Please enter your trust number.
                </div>
              </div>
              <div>
                <label class="form-label">Your ID / Passport</label>
                <input type="text" class="form-control rounded-lg focus:ring-2 focus:ring-[#033f63] focus:border-[#033f63]" formControlName="id_or_passport" placeholder="e.g. 9501 09504 3087 or 9501095043087" />
                <div class="text-danger mt-1 fst-italic" *ngIf="editLookupForm.get('id_or_passport')?.invalid && editLookupForm.get('id_or_passport')?.touched">
                  Please enter your ID or passport number.
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-secondary d-inline-flex align-items-center gap-2"
                    (click)="performEditLookup()"
                    [disabled]="editLookupForm.invalid || lookupLoading">
              <span class="spinner-border spinner-border-sm me-1" *ngIf="lookupLoading" role="status" aria-hidden="true"></span>
              Look up
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
</div>
